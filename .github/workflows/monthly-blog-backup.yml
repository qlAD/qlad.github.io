name: Monthly Blog Backup

on:
  schedule:
    - cron: '0 0 30 * *'  # æ¯æœˆ 30 å·è¿è¡Œ
  workflow_dispatch:       # æ‰‹åŠ¨è§¦å‘

jobs:
  create-release:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Calculate post and image counts
      id: counts
      run: |
        CHINESE_POST_COUNT=$(find ./content/blog -name 'index.md' | wc -l)
        ENGLISH_POST_COUNT=$(find ./content/blog -name 'index.en.md' | wc -l)
        IMAGE_COUNT=$(find ./content/blog -name '*.png' -o -name '*.jpg' -o -name '*.jpeg' | wc -l)
        ZIP_SIZE=$(du -sh ./content/blog | cut -f1)

        # Save state using new environment files
        echo "CHINESE_POST_COUNT=$CHINESE_POST_COUNT" >> $GITHUB_STATE
        echo "ENGLISH_POST_COUNT=$ENGLISH_POST_COUNT" >> $GITHUB_STATE
        echo "IMAGE_COUNT=$IMAGE_COUNT" >> $GITHUB_STATE
        echo "ZIP_SIZE=$ZIP_SIZE" >> $GITHUB_STATE

    - name: Zip blog content
      run: zip -r "blogs_${{ github.event.release.tag_name }}.zip" ./content/blog

    - name: Create GitHub Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}   # ä½¿ç”¨é»˜è®¤çš„ GitHub Token
      with:
        tag_name: ${{ github.event.release.tag_name }}
        release_name: "ğŸ“… ${{ github.event.release.tag_name }} åšå®¢æ–‡ç« å¤‡ä»½"
        draft: false
        prerelease: false
        body: |
          - **ä¸­æ–‡æ–‡ç« **: ${{ steps.counts.outputs.CHINESE_POST_COUNT }} ç¯‡
          - **è‹±æ–‡æ–‡ç« **: ${{ steps.counts.outputs.ENGLISH_POST_COUNT }} ç¯‡
          - **å›¾ç‰‡**: ${{ steps.counts.outputs.IMAGE_COUNT }} å¼ 
          - **å‹ç¼©åŒ…å¤§å°**: ${{ steps.counts.outputs.ZIP_SIZE }}

          > æ­¤å¤‡ä»½åŒ…æ‹¬æ‰€æœ‰åšå®¢æ–‡ç« å’Œå›¾ç‰‡çš„å‹ç¼©åŒ…æ–‡ä»¶ï¼Œå¯ç”¨äºæ¢å¤å’Œè¿ç§»ã€‚

    - name: Upload Release Asset
      uses: actions/upload-release-asset@v1
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: "blogs_${{ github.event.release.tag_name }}.zip"
        asset_name: "blogs_${{ github.event.release.tag_name }}.zip"
        asset_content_type: application/zip
