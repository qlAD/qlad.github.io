name: Monthly Blog Zip Release

on:
  schedule:
    - cron: '0 0 30 * *'  # æ¯æœˆ 30 å·çš„ UTC æ—¶é—´ 00:00
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  create_release:
    runs-on: ubuntu-latest

    steps:
    # æ£€å‡ºä»£ç ä»“åº“
    - name: Checkout repository
      uses: actions/checkout@v3

    # è·å–å½“å‰æ—¥æœŸï¼Œä½œä¸ºæ–‡ä»¶åå’Œ tag çš„ä¸€éƒ¨åˆ†
    - name: Get current date
      id: date
      run: echo "RELEASE_DATE=$(date +'%Y%m%d')" >> $GITHUB_ENV

    # ç»Ÿè®¡ä¸­æ–‡æ–‡ç« æ•°ï¼ˆindex.md æ–‡ä»¶ï¼‰
    - name: Count Chinese blog posts
      id: count_chinese_posts
      run: echo "CHINESE_POST_COUNT=$(find content/blog -name 'index.md' | wc -l)" >> $GITHUB_ENV

    # ç»Ÿè®¡è‹±æ–‡æ–‡ç« æ•°ï¼ˆindex.en.md æ–‡ä»¶ï¼‰
    - name: Count English blog posts
      id: count_english_posts
      run: echo "ENGLISH_POST_COUNT=$(find content/blog -name 'index.en.md' | wc -l)" >> $GITHUB_ENV

    # ç»Ÿè®¡å›¾ç‰‡æ•°ï¼ˆå‡è®¾å›¾ç‰‡æ˜¯ .jpg å’Œ .png æ ¼å¼ï¼‰
    - name: Count images
      id: count_images
      run: echo "IMAGE_COUNT=$(find content/blog -name '*.jpg' -o -name '*.png' | wc -l)" >> $GITHUB_ENV

    # è¿›å…¥ content/blog ç›®å½•å¹¶å°†å…¶ä¸­æ‰€æœ‰æ–‡ä»¶æ‰“åŒ…ä¸ºå¸¦æœ‰æ—¥æœŸçš„ zip æ–‡ä»¶
    - name: Zip all files in content/blog directory
      run: |
        cd content/blog
        zip -r ../../blogs_${{ env.RELEASE_DATE }}.zip ./*

    # è·å– zip æ–‡ä»¶å¤§å°
    - name: Get zip file size
      id: file_size
      run: echo "ZIP_SIZE=$(du -m blog_bak_${{ env.RELEASE_DATE }}.zip | cut -f1)" >> $GITHUB_ENV

    # åˆ›å»ºä¸€ä¸ª release å¹¶ä¸Šä¼  zip æ–‡ä»¶
    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: '${{ env.RELEASE_DATE }}'
        release_name: 'ğŸ“… ${{ env.RELEASE_DATE }} åšå®¢æ–‡ç« å¤‡ä»½'
        draft: false
        prerelease: false
        body: |
          ### ğŸ“… ${{ env.RELEASE_DATE }} åšå®¢æ–‡ç« å¤‡ä»½

          - **ä¸­æ–‡æ–‡ç« **: ${{ env.CHINESE_POST_COUNT }} ç¯‡
          - **è‹±æ–‡æ–‡ç« **: ${{ env.ENGLISH_POST_COUNT }} ç¯‡
          - **å›¾ç‰‡**: ${{ env.IMAGE_COUNT }} å¼ 
          - **å‹ç¼©åŒ…å¤§å°**: ${{ env.ZIP_SIZE }} MB

          > æ­¤å¤‡ä»½åŒ…æ‹¬æ‰€æœ‰åšå®¢æ–‡ç« å’Œå›¾ç‰‡çš„å‹ç¼©åŒ…æ–‡ä»¶ï¼Œå¯ç”¨äºæ¢å¤å’Œè¿ç§»ã€‚

    # ä¸Šä¼ å¸¦æ—¥æœŸçš„ zip æ–‡ä»¶åˆ° release
    - name: Upload ZIP to Release
      uses: actions/upload-release-asset@v1
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./blog_bak_${{ env.RELEASE_DATE }}.zip
        asset_name: blog_bak_${{ env.RELEASE_DATE }}.zip
        asset_content_type: application/zip
